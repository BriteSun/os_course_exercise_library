<!DOCTYPE HTML>
<html lang="en-US" >
    <!-- Start book 说明 -->
    <head>
        <!-- head:start -->
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>wd1112 | 说明</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="$gitbook serve . 运行web服务">
        <meta name="keywords" content="">
        <meta name="generator" content="GitBook 1.5.0">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
        
    
    
    <link rel="next" href="../wd1188/1188.html" />
    
    
    <link rel="prev" href="../wd1180/1180.html" />
    

        <!-- head:end -->
    </head>
    <body>
        <!-- body:start -->
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-quizzes/quizzes.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-rust-playpen/editor.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-grvis/test.css">
        
    
    

        
    <div class="book" data-level="15" data-basepath=".." data-revision="1445477045953">
    



    <div class="book-body">
        

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_14">
                    
                        <p>下面是ucore中用于按需分页处理过程的内核代码。请补全其中所缺的代码，以正确完成按需分页过程.</p>
<pre class="sh_c"><code>```
    kern/trap/trap.h
    ---------------------------------
    ...
    struct trapframe {
        struct pushregs tf_regs;
        uint16_t tf_es;
        uint16_t tf_padding1;
        uint16_t tf_ds;
        uint16_t tf_padding2;
        uint32_t tf_trapno;
        / below here defined by x86 hardware /
        uint32_t tf_err;
        uintptr_t tf_eip;
        uint16_t tf_cs;
        uint16_t tf_padding3;
        uint32_t tf_eflags;
        // below here only when crossing rings, such as from user to kernel
        uintptr_t tf_esp;
        uint16_t tf_ss;
        uint16_t tf_padding4;
    } __attribute__((packed));
    ...
    ---------------------------------
    kern/trap/trap.c
    ---------------------------------
    ...
    static int
    pgfault_handler(struct trapframe tf) {
        extern struct mm_struct check_mm_struct;
    }
    print_pgfault(tf);
        if (check_mm_struct != NULL) {
            return do_pgfault(check_mm_struct, tf-&gt;tf_err, rcr2());
        }
        panic(&quot;unhandled page fault.
&quot;);
    }
    static void
    trap_dispatch(struct trapframe tf) {
    char c;
    int ret;
    switch ( --YOUR CODE 1-- ) {
         .YOUR..
    case T_PGFLT:
    if ( --YOUR CODE 2-- ) != 0) {
    print_trapframe(trapf);
    if (current == NULL) {
    panic(&quot;handle pgfault failed. %e
&quot;,              ret);
    }
    else { ... }
    }
    break;
      ...
    }
    void
    trap(struct trapframe tf) {
        // dispatch based on what type of trap occurred
        trap_dispatch(tf);
    }
    ...
    // do_pgfault - interrupt handler to process the page fault execption
    int
    do_pgfault(struct mm_struct mm, uint32_t error_code, uintptr_t addr) {
        int ret = -E_INVAL;
        struct vma_struct vma = find_vma(mm, addr);
        if (vma == NULL || vma-&gt;vm_start &gt; addr) {
            goto failed;
        }
        switch (error_code &amp; 3) {
        default:
                / default is 3: write, present /
        case 2: / write, not present /
            if (!(vma-&gt;vm_flags &amp; VM_WRITE)) {
                goto failed;
            }
            break;
        case 1: / read, present /
            goto failed;
        case 0: / read, not present /
            if (!(vma-&gt;vm_flags &amp; (VM_READ | VM_EXEC))) {
                goto failed;
            }
        }
        uint32_t perm = PTE_U;
        if (vma-&gt;vm_flags &amp; VM_WRITE) {
            perm |= PTE_W;
        }
        addr = ROUNDDOWN(addr, PGSIZE);
        ret = -E_NO_MEM;
        if (pgdir_alloc_page(mm-&gt;pgdir, addr, perm) == 0) {
            goto failed;
        }
        ret = 0;
    failed:
        return ret;
    }
    ...
    ---------------------------------
    Pmm.h
    ---------------------------------
    ...
    //ppn is physical page number
    static inline ppn_t
    page2ppn(struct Page page) {
        return --YOUR CODE 3--;
    }
    //pa is physical address
    static inline uintptr_t
    page2pa(struct Page page) {
        return --YOUR CODE 4--;
    }
    ...
    ---------------------------------
    pmm.c
    ---------------------------------
    ...
    // virtual address of physicall page array
    struct Page pages;
    // amount of physical memory (in pages)
    size_t npage = 0;
    // virtual address of boot-time page directory
    pde_t boot_pgdir = NULL;
    ……
    // pgdir_alloc_page - call alloc_page &amp; page_insert functions to
    //                  - allocate a page size memory &amp; setup an addr map
    //                  - pa&lt;-&gt;la with linear address la and the PDT pgdir
    struct Page 
    pgdir_alloc_page(pde_t pgdir, uintptr_t la, uint32_t perm) {
        struct Page page = alloc_page();
        if (page != NULL) {
            if (page_insert(pgdir, page, la, perm) != 0) {
                free_page(page);
                return NULL;
            }
        }
        return page;
    }
    ...
    //page_insert - build the map of phy addr of an Page with the linear addr la
    // paramemters:
    //  pgdir: the kernel virtual base address of PDT
    //  page:  the Page which need to map
    //  la:    the linear address need to map
    //  perm:  the permission of this Page which is setted in related pte
    // return value: always 0
    //note: PT is changed, so the TLB need to be invalidate
    int
    page_insert(pde_t pgdir, struct Page page, uintptr_t la, uint32_t perm) {
        pte_t ptep = get_pte(pgdir, la, 1);
        if (ptep == NULL) {
            return -E_NO_MEM;
        }
        page_ref_inc(page);
        if (ptep &amp; PTE_P) {
            struct Page p = pte2page(ptep);
            if (p == page) {
                page_ref_dec(page);
            }
            else {
                page_remove_pte(pgdir, la, ptep);
            }
        }
        ptep = --YOUR CODE 5--
        tlb_invalidate(pgdir, la);
        return 0;
    }
    ---------------------------------
    ```
</code></pre><div class="active-code">
<textarea rows="10" cols="80"></textarea>
<div><input class="action-submit" type="submit" value="提交"/></div>
</div>
                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        
        
        
        
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-quizzes/quizzes.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-rust-playpen/ace/ace.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-rust-playpen/editor.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-rust-playpen/mode-rust.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-grvis/test.js"></script>
    

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2},"rust-playpen":{},"grvis":{},"quizees":{}};
    gitbook.start(config);
});
</script>

        <!-- body:end -->
    </body>
    <!-- End of book 说明 -->
</html>
